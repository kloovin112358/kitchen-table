{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit Draft{% else %}Create Post{% endif %}{% endblock %}
{% block content %}
{{ form.media }}
<div class="container pb-5 mt-3">
    <h1 class="display-5 fw-bold">{% if form.instance.pk %}Edit Draft{% else %}Create a Post{% endif %}</h1>
    <p class="mb-4">Share an update or a how-to for the family wiki.</p>
    <form method="post" id="postForm">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_category" class="form-label">Category</label>
            {{ form.category }}
        </div>

        <div class="mb-3">
            <label for="id_title" class="form-label">Title</label>
            {{ form.title }}
        </div>

        <div class="mb-3">
            <label for="id_post_body" class="form-label">Content</label>
            {{ form.post_body }}
        </div>

        <div class="mb-3">
            <label for="id_tags" class="form-label">Tags</label>
            {{ form.tags }}
            <div class="form-text">Tags help people find this post.</div>
        </div>
        <button type="submit" name="save_as_draft" class="btn btn-secondary">{% if form.instance.pk %}Save Changes{% else %}Save as Draft{% endif %}</button>
        <button type="submit" name="submit" class="btn btn-primary">Publish</button>
    </form>
</div>
<script>
const form = document.getElementById('postForm');
let isFormDirty = false;

// Mark the form as dirty when any input changes
form.addEventListener('input', () => {
isFormDirty = true;
});

// Clear the dirty flag on form submission
form.addEventListener('submit', () => {
isFormDirty = false;
});

// Warn the user before leaving the page
window.addEventListener('beforeunload', (event) => {
if (isFormDirty) {
    event.preventDefault();
    // Modern browsers require this string, though it won't be shown in the dialog
    event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    return 'You have unsaved changes. Are you sure you want to leave?';
}
});
    function customFilePicker(callback, value, meta) {
        let input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', meta.filetype === 'image' ? 'image/*' : 'video/*');

        input.onchange = function () {
            let file = this.files[0];

            // Use FormData to send the file to the server
            let formData = new FormData();
            formData.append('file', file);

            fetch('/upload/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Pass the file URL back to TinyMCE
                callback(data.location);
            })
            .catch(error => {
                console.error('Error uploading file:', error);
            });
        };

        input.click();
    }
</script>
{% endblock %}