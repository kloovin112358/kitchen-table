{% extends 'base.html' %}

{% block title %}My Account{% endblock %}
{% block content %}
<div class="container pb-5 mt-3">
    <h1 class="display-4 fw-bold">{{request.user.get_full_name}}</h1>
    <p>{{request.user.email}}</p>
    {% if request.user.profile_photo %}
    <div>
      <img src="{{ request.user.profile_photo.url }}" style="width:300px;" alt="{{request.user.get_full_name}} Profile Photo" class="rounded" />  
    </div>   
    {% endif %}
    <button class="btn btn-link ps-0 text-decoration-none" data-bs-toggle="modal" data-bs-target="#exampleModal">
      {% if request.user.profile_photo %}
        Edit profile photo
      {% else %}
        <i class="bi bi-plus-lg"></i> Add profile photo
      {% endif %}
    </button>
    <div class="mt-5">
      <form action="{% url 'sign-out' %}" method="post" id="logout-form" style="display: none;">
          {% csrf_token %}
          <button type="submit" class="btn btn-link">Logout</button>
      </form>
      <button onclick="document.getElementById('logout-form').submit(); return false;" class="btn btn-outline-dark"><i class="bi bi-door-closed"></i> Sign Out</button>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-describedby="exampleModalDescription" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" id="editProfilePhotoForm">
        {% csrf_token %}
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Profile Photo</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="exampleModalDescription" class="visually-hidden">Use this form to upload a new profile photo. Your current photo will be replaced.</p>

          <!-- Existing File Preview -->
          {% if user.profile_photo %}
            <div class="mb-3">
              <label for="currentPhoto">Current Profile Photo:</label>
              <div class="mt-2">
                <img src="{{ user.profile_photo.url }}" alt="Current profile photo" class="img-fluid rounded mb-3" style="max-height: 150px;" id="currentPhoto">
              </div>
            </div>
          {% endif %}

          <!-- File Input -->
          <div class="mb-3">
            <label for="profilePhotoInput" class="form-label">Upload new profile photo*</label>
            <input
              class="form-control"
              type="file"
              id="profilePhotoInput"
              name="profile_photo"
              accept="image/*"
              aria-describedby="profilePhotoHint"
            >
            <small id="profilePhotoHint" class="form-text text-muted">Supported formats: JPEG, PNG. Max size: 5MB.</small>
          </div>

          <!-- File Preview -->
          <div id="previewContainer" class="mt-3 d-none" aria-live="polite">
            <label for="filePreview">New photo:</label>
            <div class="mt-2">
              <img id="filePreview" class="img-fluid rounded" style="max-height: 150px;" alt="New profile photo preview"/>
            </div>
            {% if user.profile_photo %}
              <small class="text-muted">Note: Your old profile photo will be deleted.</small>
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close modal">Close</button>
          <button class="btn btn-primary" id="saveChangesButton" disabled>Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("exampleModal");

    // Move focus back to the triggering button when the modal is hidden
    modal.addEventListener("hide.bs.modal", () => {
      if (document.activeElement) {
        document.activeElement.blur()
      }
    });

    const fileInput = document.getElementById("profilePhotoInput");
    const saveButton = document.getElementById("saveChangesButton");
    const previewContainer = document.getElementById("previewContainer");
    const filePreview = document.getElementById("filePreview");

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];

      if (file) {
        // Enable the save button
        saveButton.disabled = false;

        // Show preview container
        previewContainer.classList.remove("d-none");

        // Display the image preview
        const reader = new FileReader();
        reader.onload = (e) => {
          filePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        // Disable the save button and hide the preview if no file is selected
        saveButton.disabled = true;
        previewContainer.classList.add("d-none");
        filePreview.src = "";
      }
    });
  });
</script>
{% endblock %}
